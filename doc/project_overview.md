# go-codegen Project Overview

## Purpose
go-codegen is a code generator framework - a "swiss army knife" for creating custom code generators in Go. It provides the infrastructure and patterns for building various types of code generators, with the flexibility to add new generators as needed. Currently implements cloner and und-related generators, with more generators planned for the future.

## Project Structure
```
go-codegen/
├── codegen/           # Main code generator implementation
│   ├── cmd/          # CLI commands for generators
│   ├── generator/    # Generator implementations
│   │   ├── cloner/   # Clone method generator
│   │   └── undgen/   # Undefined type generators
│   ├── imports/      # Import management
│   ├── matcher/      # Type matching logic
│   ├── typegraph/    # Type dependency graph
│   └── suffixwriter/ # Output file writing with suffixes
└── pkg/              # Runtime libraries
    └── cloner/       # Runtime support for cloned types
        └── runtime/
```

## Code Generator Framework

The framework provides:
- **Type Graph Analysis**: Builds dependency graphs between types across packages
- **AST Manipulation**: Using `github.com/dave/dst` for code generation with decorations
- **Package Loading**: Full type information loading via `golang.org/x/tools/go/packages`
- **Matcher System**: Configurable rules for determining which types need generation
- **File Writing System**: Consistent file naming with suffixes and automatic formatting
- **Directive Comments**: Fine-grained control over generation behavior

## Current Generators

### 1. Cloner Generator
- **Purpose**: Generates deep clone methods for Go types
- **Non-generic types**: Generates `Clone() T` methods
- **Generic types**: Generates `CloneFunc(cloneT func(T) T, ...) T` methods requiring clone functions for each type parameter
- **Features**:
  - Deep cloning of complex nested structures
  - Support for slices, maps, pointers, and custom types
  - Configurable behavior via directive comments
  - Handles channels, functions, interfaces intelligently
  - Respects no-copy types (types with `Lock` method)

### 2. Undgen Generator Suite
Generates code for types containing definitions from `github.com/ngicks/und` package:

- **und_patch**: Generates patcher types for partial updates
  - Creates types with optional fields for PATCH operations
  - Useful for API endpoints that accept partial updates
  
- **und_plain**: Generates plain types and conversion methods
  - Converts between und types and standard Go types
  - Provides conversion methods in both directions
  
- **und_validator**: Generates validation methods
  - Creates validation logic for und-based types
  - Ensures data integrity and constraints

## Tech Stack
- **Language**: Go 1.23.0 or later
- **Key Dependencies**:
  - `github.com/dave/dst` - Go AST manipulation with decorations
  - `golang.org/x/tools/go/packages` - Go package loading and type analysis
  - `github.com/spf13/cobra` - CLI framework for commands
  - `github.com/ngicks/und` - Undefined/nullable type support
  - `golang.org/x/tools/cmd/goimports` - Required for formatting generated code

## Build System
- Standard Go modules with workspace support
- Uses standard Go toolchain commands (no Makefile)
- Automatic code formatting via goimports
- Generated files use specific suffixes:
  - `.clone.go` - Cloner generated files
  - `.und_patch.go` - Patch type files
  - `.und_plain.go` - Plain type conversion files
  - `.und_validator.go` - Validator method files

## Generated Code Standards
All generated files include a mandatory header:
```go
// Code generated by github.com/ngicks/go-codegen/codegen DO NOT EDIT.
```

This header:
- Identifies files as generated (prevents manual editing)
- Helps tools like `go generate` track generated files
- Ensures git and code review tools can handle appropriately

## Security Considerations
- Package paths must be relative to working directory (security constraint)
- No execution of arbitrary code during generation
- Generated code does not include sensitive information
- All file operations are restricted to project scope

## Framework Architecture
The framework is designed to be extensible:
- New generators can be added by implementing the generator interface
- Shared utilities for AST manipulation, type analysis, and file operations
- Common patterns for handling generics, embedded types, and complex type relationships
- Reusable components for directive comment processing and import management

## Module Organization
The project is organized as a monorepo with multiple modules:
- `codegen/` - Main generator framework and implementations (not intended for direct import)
- `pkg/cloner/runtime/` - Runtime support library for cloner (stable for import)

Each module maintains its own `go.mod` for dependency management.

## Future Expansion

### Planned Generators

#### Functional Options Pattern Generator
- Reads struct fields and generates functional options for unexported fields
- Creates typed options (not functions) for each field with an `apply` method
- Options are interfaces - comparable when field types are comparable
- Solves the typical problem of functional options not being comparable (since they're usually functions)

#### Interface Wrapper Generator
- Generates a wrapper struct for structs containing interface fields
- The wrapper implements the same interface, delegating to the wrapped instance
- Methods following specific naming conventions can trap/intercept input and output of delegated methods
- Useful for adding cross-cutting concerns like logging, metrics, or validation

The framework provides the foundation - package loading, type analysis, AST manipulation, and file writing - making it straightforward to implement these and other generator types.