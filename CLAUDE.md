# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Documentation Structure

Project documentation is stored in the `./doc` directory. Key documentation files include:

- **doc/todo.md**: Active task tracking and remaining work items
- **doc/project_overview.md**: Project overview, tech stack, and dependencies
- **doc/commands.md**: Build, test, and code generation commands
- **doc/architecture.md**: Project architecture and file organization
- **doc/generators.md**: Detailed information about cloner and undgen generators

### Task Management

Always check and update `doc/todo.md` when:
- Starting new work on this project
- Completing tasks
- Discovering new issues or requirements
- Planning future work

## Using Serena MCP Tool

This project has been onboarded with the Serena MCP tool. Use `mcp__serena__` commands to access and store project information. The serena memories complement the documentation in the `./doc` directory.

You'll have to read/update serena memory where relevant, and ensure consistency between serena memories and doc directory contents.

## Critical Project-Specific Information

### Required Tool Installation

Tests require goimports to be installed:

```bash
go install golang.org/x/tools/cmd/goimports@latest
```

## High-Level Architecture (Not in Serena Memory)

### Core Flow

1. **Package Loading**: Uses `golang.org/x/tools/go/packages` to load Go packages with full type information
2. **Type Graph Construction**: `typegraph.Graph` builds dependency graph between types, mapping Parent/Children edges across packages
3. **Matching**: Configurable `MatcherConfig` determines which types need code generation based on rules for channels, functions, interfaces, no-copy types
4. **Code Generation**: Generators traverse type graph and emit code using AST manipulation (`github.com/dave/dst`)
5. **File Writing**: `suffixwriter.Writer` handles output with automatic suffix addition and goimports processing

### Generator-Specific Behavior

**Cloner Generator**:

- Non-generic types: generates `Clone() T` methods
- Generic types: generates `CloneFunc(cloneT func(T) T, ...) T` methods requiring clone functions for each type parameter
- Per-field directives via comments (e.g., `//cloner:copyptr`) override global configuration

### Critical Implementation Details

- Generated files must include header: `// Code generated by github.com/ngicks/go-codegen/codegen DO NOT EDIT.`
- Package paths must be relative to working directory (security constraint)
- File suffixes: `.clone.go`, `.und_patch.go`, `.und_plain.go`, `.und_validator.go`

- ask back the user if you can't determine the things.